---
title: "Selection Bias & Missing Data Challenge - Part 2"
subtitle: "Creating a Statistics Meme: Visualizing Selection Bias"
format:
  html: default
execute:
  echo: true
  eval: true
---


### Python

```{python}
#| label: load-images
#| echo: false
#| eval: false

import numpy as np
from PIL import Image
import matplotlib.pyplot as plt

# Load original image
original_img = Image.open('cheeseburger2.png')
if original_img.mode != 'L':
    original_img = original_img.convert('L')
original_array = np.array(original_img, dtype=np.float32) / 255.0

# Load stippled image (from Part 1 - see https://flyaflya.github.io/stippleChallenge/)
# stipple_array = np.load('stippleImage.npy')  # Commented out - using R instead

print(f"Original: {original_array.shape}, Stipple: {stipple_array.shape}")
```

### R

```{r}
#| label: load-images-r
#| echo: false
#| eval: true

library(magick)

# Load original image
original_img <- image_read('cheeseburger2.png')
original_img <- image_convert(original_img, colorspace = "Gray")

# Get image dimensions
img_info <- image_info(original_img)
img_width <- img_info$width
img_height <- img_info$height

# Convert to matrix [h, w] and normalize
img_array <- as.numeric(image_data(original_img, "gray")[1,,])
dim(img_array) <- c(img_width, img_height)
original_array <- t(img_array) / 255.0  # [height, width]

# Load stippled image (from Part 1 - see https://flyaflya.github.io/stippleChallenge/)
# Adjust based on how you saved it - could be .RData, .rds, or regenerate
stipple_array <- readRDS('stippleImage.rds')

cat("Original dimensions:", dim(original_array), "\n")
cat("Stipple dimensions:", dim(stipple_array), "\n")
```


:::

### Step 2: Create the Block Letter "S"

Create a matrix matching your image dimensions with a bold letter "S" rendered as black pixels on a white background.

```{r}
#| label: create-s-letter
#| echo: false
#| eval: true

# Get dimensions from original image
h <- nrow(original_array)
w <- ncol(original_array)

# Draw "S" using base R graphics
# Create a temporary PNG file
temp_file <- tempfile(fileext = ".png")
png(temp_file, width = w, height = h, bg = "white", res = 150, units = "px")
par(mar = c(0, 0, 0, 0), xaxs = "i", yaxs = "i")
plot.new()
plot.window(xlim = c(0, 1), ylim = c(0, 1))
# Draw bold "S" letter - adjust size based on image dimensions
font_size <- min(w, h) / 50
text(0.5, 0.5, "S", cex = font_size, font = 2, col = "black", family = "sans")
dev.off()

# Read the image back and resize to exact dimensions
s_img <- image_read(temp_file)
s_img <- image_resize(s_img, paste0(w, "x", h, "!"))
unlink(temp_file)

# Convert to matrix [h, w] and normalize
s_array_raw <- as.numeric(image_data(s_img, "gray")[1,,])
dim(s_array_raw) <- c(w, h)
s_array <- t(s_array_raw) / 255.0  # [height, width]

cat("S letter dimensions:", dim(s_array), "\n")
```

### Step 3: Create the Masked Estimate

Your stippled image is a matrix where black dots (0.0) represent data points and white (1.0) is background. The "S" matrix shows where selection bias occurs (black "S" = missing data). To create the masked estimate, remove stipple points (set to white) wherever the "S" is black.

```{r}
#| label: create-masked-estimate
#| echo: false
#| eval: true

# Create binary mask: where "S" is black (value < 0.5), that's the mask
threshold <- 0.5
s_mask <- s_array < threshold

# Apply mask to stippled image: where "S" is black, set to white (remove stipples)
masked_stipple <- stipple_array
masked_stipple[s_mask] <- 1.0  # Set masked areas to white

cat("Masked estimate created\n")
```

### Step 4: Assemble the Four-Panel Meme

Use the image composition capabilities of matplotlib (Python) or imager (R) to arrange your four matrices as panels in a single figure.

```{r}
#| label: create-meme
#| echo: false
#| eval: true
#| fig-cap: "Four-panel statistics meme demonstrating selection bias"
#| fig-width: 12
#| fig-height: 3
#| dpi: 300

# Flip images only vertically so they are upright
original_plot <- original_array[nrow(original_array):1, , drop = FALSE]
stipple_plot  <- stipple_array[nrow(stipple_array):1, , drop = FALSE]
s_plot        <- s_array[nrow(s_array):1, , drop = FALSE]

# Build the masked estimate in the same orientation
# Black parts of S = selection bias region
s_mask <- s_plot < 0.5

# Start from the stippled image and remove dots inside the S
estimate_plot <- stipple_plot
estimate_plot[s_mask] <- 1.0   # set masked areas to white

# Get dimensions for display (use original_plot dimensions)
h <- nrow(original_plot)
w <- ncol(original_plot)

# Set up 1x4 layout with minimal spacing
par(mfrow = c(1, 4),
    mar = c(2, 1, 3, 1),
    bg  = "pink",
    oma = c(0, 0, 0, 0))

# Panel 1: Reality (original image)
image(t(original_plot), 
      col  = gray(seq(0, 1, length.out = 256)),
      xlab = "", ylab = "", axes = FALSE, 
      main = "Reality", 
      asp  = h / w)

# Panel 2: Your Model (stippled image)
image(t(stipple_plot), 
      col  = gray(seq(0, 1, length.out = 256)),
      xlab = "", ylab = "", axes = FALSE, 
      main = "Your Model", 
      asp  = h / w)

# Panel 3: Selection Bias (S letter)
image(t(s_plot), 
      col  = gray(seq(0, 1, length.out = 256)),
      xlab = "", ylab = "", axes = FALSE, 
      main = "Selection Bias", 
      asp  = h / w)

# Panel 4: Estimate (masked stippled image)
image(t(estimate_plot), 
      col  = gray(seq(0, 1, length.out = 256)),
      xlab = "", ylab = "", axes = FALSE, 
      main = "Estimate", 
      asp  = h / w)
```
